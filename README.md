# Электронная таблица
## Описание проекта:
Библиотека на C++ для создания и вычисления электронных таблиц с поддержкой формул.\
Представляет собой ядро, которое можно встроить в другое приложение. Управление таблицей осуществляется через интерфейс класса Sheet.

Ячейки могут быть трёх типов:
- **Empty** - пустая ячейка. Автоматически создаётся, когда на неё ссылаются другие ячейки.\
Удаляется только после того, как исчезнут все ссылки на неё (проверяется методом `Cell::IsReferenced()`).
- **Text** - текстовая ячейка. Может содержать любую строку. Если строка начинается с символа `'` (апостроф), то при получении значение методом `Cell::GetValue()` этот символ опускается (позволяет записать текст, начинающийся с `=`, не интерпретируя его как формулу). При вычислении формул текстовая ячейка пытается преобразоваться в число, если это не удаётся, возникает ошибка `#VALUE!`.
- **Formula** - формульная ячейка. Содержит выражение, начинающееся с символа `=`. Примеры: `=1`, `=A1 + A2`, `=(B3*2)/C4`. Формула вычисляется динамически с учётом зависимости от других ячеек.

Для смены типов ячеек налету применён паттерн PImpl.

### Управление зависимостями и кеширование:
Каждая формульная ячейка хранит результат вычисления в кэше. При изменении любой ячейки, от которой она зависит, кэш сбрасывается. Для этого поддерживаются обратные ссылки: каждая ячейка знает, какие ячейки на неё ссылаются. Это позволяет эффективно инвалидировать кэш по цепочке.


### Обнаружение циклических зависимостей:
В таблице реализован алгоритм поиска циклов на основе поиска в глубину с раскраской вершин:
- **White** - вершина ещё не посещалась.
- **Gray** - вершина посещена, но не все её потомки обработаны (находиться в текущем стеке вызовов).
- **Black** - вершина и все её потомки обработаны.

Если при обходе потомков встречается серая вершина, значит обнаружен цикл (например `A1 = B1`, `B1 = A1`). В этом случае изменение ячейки отменяется, выбрасывается исключение **CircularDependencyException**. Содержимое ячейки остаётся прежним.

При обнаружении циклической зависимости, стек вызовов раскручивается от вершины, на которой выброшено исключение, до вершины с тем же индексом. Зависимость может занимать часть стека или весь стек - это зависит от пути, по которому возникло замыкание. Этот путь извлекается и инвертируется для визуализации цикла.

### Поддерживаемые ошибки вычислений:
- **#VALUE!** - значение не может быть интерпретировано как число.
- **#REF!** - ссылка на некорректную позицию, индекс строки или столбца за пределами допустимого диапазона.
- **#ARITHM!** - арифметическая ошибка, например деление на ноль.

### Построение AST для формул:
Для разбора формул используется генератор парсеров ANTLR. Грамматика описана в файле **Formula.g4**.\
Поддерживаются:
- Бинарные операции: `+`, `-`, `*`, `/` (с учётом приоритета).
- Унарные операции: унарный плюс и минус.
- Скобки для изменения приоритета.
- Числовые константы (целые и с плавающей точкой).
- Ссылки на ячейки в формате **A1**, **B2**, ... (латинские буквы - столбец, число - строка).

На основе грамматики генерируется лексер, парсер и базовые классы для обхода дерева.\
Полученное абстрактное синтаксическое дерево(AST) используется для вычисления значения формулы и получения списка зависимых ячеек.

## Внешние зависимости:
Для сборки проекта необходимы:
- ANTLR 4.13.2 (Java-архив и C++ runtime).
- Java Runtime Environment (для запуска ANTLR во время генерации парсера).

### Установка зависимостей:
1. Скачайте **antlr-4.13.2-complete.jar** c [официального сайта ANTLR](https://www.antlr.org/download.html) и поместите в корневую директорию проекта.
2. Скачайте C++ runtime для ANTLR (архив **antlr4-cpp-runtime-4.13.2-source.zip**) и распакуйте его содержимое в папку **antlr4_runtime** в корне проекта.
3. Установите JDK, чтобы иметь возможность запускать `java -jar`.

## Сборка:
```bash
mkdir build && cd build
cmake .. -DCMAKE_POLICY_VERSION_MINIMUM=X # Замените X на версию cmake, обязательно старше 3.5
cmake --build .
```
Если собирать проект без указания доп. параметра возникает ошибка:

```bash
CMake Error at build/_deps/googletest-src/CMakeLists.txt:4 (cmake_minimum_required):
  Compatibility with CMake < 3.5 has been removed from CMake.

  Update the VERSION argument <min> value.  Or, use the <min>...<max> syntax
  to tell CMake that the project requires at least <min> but has been updated
  to work with policies introduced by <max> or earlier.

  Or, add -DCMAKE_POLICY_VERSION_MINIMUM=3.5 to try configuring anyway.

```

После успешной сборки в директории **build** появится исполняемый файл **spreadsheet.exe**. Он запускает набор тестов, демонстрирующих работу библиотеки.

Для использования библиотеки в своём проекте подключите исходные файлы или соберите статическую библиотеку (для этого потребуется модифицировать **CMakeLists.txt**).

## Заключение:
Данная библиотека реализует ключевые механизмы электронных таблиц: различные типы ячеек, вычисление формул, управление зависимостями, обнаружение циклов и обработку ошибок. Она может служить основой для создания приложений с табличным функционалом.